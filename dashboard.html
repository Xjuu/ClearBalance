<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ClearBalance</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
    <style>
        :root {
            --primary: #333446;
            --secondary: #7F8CAA;
            --accent: #B8CFCE;
            --light: #EAEFEF;
            --white: #FFFFFF;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --shadow: rgba(51, 52, 70, 0.1);
            --shadow-lg: rgba(51, 52, 70, 0.15);
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light);
            color: var(--primary);
            line-height: 1.6;
        }
        body.dark-mode {
            --primary: #EAEFEF;
            --secondary: #B8CFCE;
            --accent: #7F8CAA;
            --light: #1a1b26;
            --white: #24283b;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-lg: rgba(0, 0, 0, 0.4);
        }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            border-right: 1px solid rgba(127, 140, 170, 0.1);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(127, 140, 170, 0.1);
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 500;
        }
        .nav-menu { padding: 1.5rem 0; }
        .nav-item {
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--secondary);
            font-weight: 500;
        }
        .nav-item:hover { background: var(--light); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { font-size: 1.25rem; }
        .main-content { margin-left: var(--sidebar-width); flex: 1; min-height: 100vh; }
        .top-bar {
            background: var(--white);
            border-bottom: 1px solid rgba(127, 140, 170, 0.1);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }
        .top-bar-left { display: flex; align-items: center; gap: 1.5rem; }
        .account-selector {
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            background: var(--white);
            color: var(--primary);
            transition: all 0.3s ease;
        }
        .account-selector:hover { border-color: var(--accent); }
        .currency-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--secondary);
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 8px;
        }
        .top-bar-right { display: flex; align-items: center; gap: 1.5rem; }
        .theme-toggle, .lang-selector {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 2px solid var(--light);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--secondary);
            transition: all 0.3s ease;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
        }
        .theme-toggle:hover, .lang-selector:hover { 
            background: var(--light); 
            color: var(--primary); 
        }
        .profile-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .profile-menu:hover { background: var(--light); }
        .profile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .content { padding: 2rem; }
        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-title {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        .page-subtitle {
            color: var(--secondary);
            font-size: 1rem;
            margin-top: 0.5rem;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            border: 1px solid rgba(127, 140, 170, 0.1);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            box-shadow: 0 8px 24px var(--shadow);
            transform: translateY(-4px);
        }
        .stat-label {
            color: var(--secondary);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.75rem;
        }
        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--error); }
        .data-table {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(127, 140, 170, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead { background: var(--light); }
        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        td {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(127, 140, 170, 0.05);
        }
        tbody tr { transition: background 0.2s ease; }
        tbody tr:hover { background: var(--light); }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-lg);
        }
        .btn-secondary { background: var(--light); color: var(--primary); }
        .btn-secondary:hover { background: var(--accent); }
        .btn-danger { background: var(--error); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-icon {
            padding: 0.5rem;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--secondary);
            transition: all 0.3s ease;
            font-size: 1.25rem;
        }
        .btn-icon:hover { background: var(--light); color: var(--primary); }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(51, 52, 70, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlide 0.4s ease;
        }
        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
            transition: color 0.3s ease;
        }
        .modal-close:hover { color: var(--primary); }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-weight: 500;
            font-size: 0.95rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--primary);
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(184, 207, 206, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .type-option {
            flex: 1;
            padding: 1.25rem;
            border: 2px solid var(--light);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--white);
        }
        .type-option:hover { border-color: var(--accent); background: var(--light); }
        .type-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        .type-option-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .type-option-label {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .category-item {
            padding: 1rem;
            border: 2px solid var(--light);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--white);
        }
        .category-item:hover { border-color: var(--accent); background: var(--light); }
        .category-item.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        .category-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .category-label {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .chart-container {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-header { margin-bottom: 1.5rem; }
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--light);
            border-radius: 6px;
            overflow: hidden;
            margin: 0.75rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            border-radius: 6px;
            transition: width 0.4s ease;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-success { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .badge-warning { background: rgba(255, 152, 0, 0.1); color: var(--warning); }
        .badge-error { background: rgba(244, 67, 54, 0.1); color: var(--error); }
        .badge-info { background: rgba(127, 140, 170, 0.1); color: var(--secondary); }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--secondary);
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        .empty-state-text { margin-bottom: 1.5rem; }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .asset-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(127, 140, 170, 0.1);
            margin-bottom: 1rem;
        }
        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .asset-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .asset-ticker {
            font-family: 'JetBrains Mono', monospace;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        .asset-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .asset-gain {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .cards-grid { grid-template-columns: 1fr; }
            .top-bar { padding: 1rem; flex-wrap: wrap; }
            .content { padding: 1rem; }
            .page-title { font-size: 1.75rem; }
        }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">CB</div>
                    <span>ClearBalance</span>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-page="overview">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-label">Overview</span>
                </div>
                <div class="nav-item" data-page="accounts">
                    <span class="nav-icon">üí≥</span>
                    <span class="nav-label">Accounts</span>
                </div>
                <div class="nav-item" data-page="transactions">
                    <span class="nav-icon">üí∏</span>
                    <span class="nav-label">Transactions</span>
                </div>
                <div class="nav-item" data-page="recurring">
                    <span class="nav-icon">üîÑ</span>
                    <span class="nav-label">Recurring</span>
                </div>
                <div class="nav-item" data-page="subscriptions">
                    <span class="nav-icon">üì±</span>
                    <span class="nav-label">Subscriptions</span>
                </div>
                <div class="nav-item" data-page="debts">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-label">Debts</span>
                </div>
                <div class="nav-item" data-page="piggy-banks">
                    <span class="nav-icon">üê∑</span>
                    <span class="nav-label">Savings Goals</span>
                </div>
                <div class="nav-item" data-page="portfolio">
                    <span class="nav-icon">üìà</span>
                    <span class="nav-label">Portfolio</span>
                </div>
                <div class="nav-item" data-page="analytics">
                    <span class="nav-icon">üìâ</span>
                    <span class="nav-label">Analytics</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-label">Settings</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <select class="account-selector" id="accountSelector">
                        <option value="all">All Accounts</option>
                    </select>
                    <div class="currency-display" id="currencyDisplay">USD</div>
                </div>
                <div class="top-bar-right">
                    <select class="lang-selector" id="langSelector">
                        <option value="en">üá¨üáß EN</option>
                        <option value="de">üá©üá™ DE</option>
                        <option value="pl">üáµüá± PL</option>
                    </select>
                    <button class="theme-toggle" id="themeToggle">üåô</button>
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-avatar" id="profileAvatar">U</div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content" id="contentArea">
                <!-- Dynamic content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Transaction</h2>
                <button class="modal-close" onclick="closeModal('transactionModal')">√ó</button>
            </div>
            <form id="transactionForm">
                <div class="type-selector">
                    <div class="type-option selected" data-type="expense">
                        <div class="type-option-icon">üí∏</div>
                        <div class="type-option-label">Expense</div>
                    </div>
                    <div class="type-option" data-type="income">
                        <div class="type-option-icon">üí∞</div>
                        <div class="type-option-label">Income</div>
                    </div>
                </div>
                <input type="hidden" id="transactionType" value="expense">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Account</label>
                        <select id="transactionAccount" required>
                            <option value="">Select account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Category</label>
                        <div class="category-grid" id="categoryGrid">
                            <!-- Categories will be loaded dynamically -->
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Description (Optional)</label>
                        <input type="text" id="transactionDescription" placeholder="Add a note...">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Save Transaction
                </button>
            </form>
        </div>
    </div>

    <!-- Account Modal -->
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Account</h2>
                <button class="modal-close" onclick="closeModal('accountModal')">√ó</button>
            </div>
            <form id="accountForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Account Name</label>
                        <input type="text" id="accountName" required placeholder="e.g., Main Checking">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="accountType" required>
                            <option value="personal">Personal</option>
                            <option value="business">Business</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select id="accountCurrency" required></select>
                    </div>
                    <div class="form-group full-width">
                        <label>Initial Balance</label>
                        <input type="number" id="accountBalance" step="0.01" value="0" required>
                    </div>
                    <div class="form-group full-width" id="advancedFields" style="display:none;">
                        <label>IBAN (Optional)</label>
                        <input type="text" id="accountIban" placeholder="DE89370400440532013000">
                    </div>
                    <div class="form-group" id="swiftField" style="display:none;">
                        <label>SWIFT/BIC (Optional)</label>
                        <input type="text" id="accountSwift" placeholder="COBADEFFXXX">
                    </div>
                    <div class="form-group" id="accountNumberField" style="display:none;">
                        <label>Account Number (Optional)</label>
                        <input type="text" id="accountNumber" placeholder="1234567890">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Save Account
                </button>
            </form>
        </div>
    </div>

    <!-- Asset Modal -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Asset</h2>
                <button class="modal-close" onclick="closeModal('assetModal')">√ó</button>
            </div>
            <form id="assetForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Asset Type</label>
                        <select id="assetType" required>
                            <option value="stock">Stock</option>
                            <option value="etf">ETF</option>
                            <option value="crypto">Cryptocurrency</option>
                            <option value="property">Real Estate</option>
                        </select>
                    </div>
                    <div class="form-group" id="tickerField">
                        <label id="tickerLabel">Ticker Symbol</label>
                        <input type="text" id="assetTicker" placeholder="AAPL">
                    </div>
                    <div class="form-group" id="exchangeField" style="display:none;">
                        <label>Stock Exchange</label>
                        <select id="assetExchange">
                            <option value="">USA (default)</option>
                            <option value="L">London (LSE)</option>
                            <option value="DE">Germany (XETRA)</option>
                            <option value="PA">Paris (Euronext)</option>
                            <option value="MI">Milan (Borsa)</option>
                            <option value="AS">Amsterdam</option>
                            <option value="BR">Brussels</option>
                            <option value="SW">Switzerland</option>
                            <option value="TO">Toronto</option>
                            <option value="HK">Hong Kong</option>
                            <option value="T">Tokyo</option>
                        </select>
                    </div>
                    <div class="form-group" id="cryptoCurrencyField" style="display:none;">
                        <label>Display Currency</label>
                        <select id="cryptoCurrency">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="JPY">JPY</option>
                            <option value="PLN">PLN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Asset Name</label>
                        <input type="text" id="assetName" required placeholder="e.g., Apple Inc.">
                    </div>
                    <div class="form-group">
                        <label id="quantityLabel">Quantity/Shares</label>
                        <input type="number" id="assetQuantity" step="0.000001" min="0" required>
                    </div>
                    <div class="form-group">
                        <label id="priceLabel">Purchase Price</label>
                        <input type="number" id="assetPurchasePrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Purchase Date</label>
                        <input type="date" id="assetPurchaseDate" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Add Asset
                </button>
            </form>
        </div>
    </div>

    <!-- Debt Modal -->
    <div class="modal" id="debtModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Debt</h2>
                <button class="modal-close" onclick="closeModal('debtModal')">√ó</button>
            </div>
            <form id="debtForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Debt Name</label>
                        <input type="text" id="debtName" required placeholder="e.g., Car Loan">
                    </div>
                    <div class="form-group">
                        <label>Principal Amount</label>
                        <input type="number" id="debtPrincipal" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (%)</label>
                        <input type="number" id="debtInterestRate" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Term (Months)</label>
                        <input type="number" id="debtTermMonths" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Day (1-31)</label>
                        <input type="number" id="debtPaymentDay" min="1" max="31" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Start Date</label>
                        <input type="date" id="debtStartDate" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Calculate & Save
                </button>
            </form>
        </div>
    </div>

    <!-- Piggy Bank Modal -->
    <div class="modal" id="piggyBankModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Savings Goal</h2>
                <button class="modal-close" onclick="closeModal('piggyBankModal')">√ó</button>
            </div>
            <form id="piggyBankForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Goal Name</label>
                        <input type="text" id="piggyBankName" required placeholder="e.g., Emergency Fund">
                    </div>
                    <div class="form-group">
                        <label>Target Amount</label>
                        <input type="number" id="piggyBankTarget" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Current Amount</label>
                        <input type="number" id="piggyBankCurrent" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group full-width">
                        <label>Target Date (Optional)</label>
                        <input type="date" id="piggyBankDeadline">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Save Goal
                </button>
            </form>
        </div>
    </div>

    <script>
        // Custom Cookie Storage for cross-subdomain session sharing
        class CookieStorage {
            constructor() {
                this.domain = '.clearbalance.xyz'; // Works on both clearbalance.xyz and dashboard.clearbalance.xyz
            }

            getItem(key) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [cookieKey, cookieValue] = cookie.trim().split('=');
                    if (cookieKey === key) {
                        try {
                            return decodeURIComponent(cookieValue);
                        } catch (e) {
                            return null;
                        }
                    }
                }
                return null;
            }

            setItem(key, value) {
                const encodedValue = encodeURIComponent(value);
                const expires = new Date();
                expires.setDate(expires.getDate() + 7); // 7 day expiry
                
                document.cookie = `${key}=${encodedValue}; domain=${this.domain}; path=/; expires=${expires.toUTCString()}; secure; samesite=lax`;
            }

            removeItem(key) {
                document.cookie = `${key}=; domain=${this.domain}; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; secure; samesite=lax`;
            }
        }

        // Configure Supabase with cookie-based session storage
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const { createClient } = supabase;
        const cookieStorage = new CookieStorage();
        
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                storage: cookieStorage, // Using cookie storage instead of localStorage
                storageKey: 'cb-auth-token',
                flowType: 'pkce'
            }
        });

        // Global State
        let currentUser = null;
        let currentLanguage = 'en';
        let translations = {};
        let accounts = [];
        let currentPage = 'overview';
        let selectedTransactionType = 'expense';
        let selectedCategory = null;

        // Currency list (50+ currencies)
        const CURRENCIES = [
            'USD', 'EUR', 'GBP', 'JPY', 'CNY', 'CAD', 'AUD', 'CHF',
            'SEK', 'NZD', 'MXN', 'SGD', 'HKD', 'NOK', 'KRW', 'TRY',
            'INR', 'RUB', 'BRL', 'ZAR', 'DKK', 'PLN', 'THB', 'MYR',
            'IDR', 'HUF', 'CZK', 'ILS', 'CLP', 'PHP', 'AED', 'COP',
            'SAR', 'RON', 'VND', 'ARS', 'EGP', 'PKR', 'BDT', 'NGN',
            'UAH', 'PEN', 'QAR', 'KZT', 'MAD', 'KWD', 'OMR', 'JOD',
            'BHD', 'LYD'
        ];

        // Category icons
        const CATEGORY_ICONS = {
            // Income
            salary: 'üíº', freelance: 'üíª', investment: 'üìà', rental: 'üè†',
            business: 'üè¢', grant: 'üéÅ', dividend: 'üíµ', interest: 'üí∞', other: 'üí∏',
            // Expense
            housing: 'üèòÔ∏è', transportation: 'üöó', food: 'üçî', utilities: 'üí°',
            healthcare: 'üè•', entertainment: 'üéÆ', shopping: 'üõçÔ∏è', education: 'üìö',
            insurance: 'üõ°Ô∏è', debt: 'üí≥', savings: 'üê∑', payroll: 'üë•',
            marketing: 'üì¢', operations: '‚öôÔ∏è', taxes: 'üèõÔ∏è', legal: '‚öñÔ∏è',
            software: 'üíæ'
        };

        // Initialize App
        async function initApp() {
            try {
                console.log('Initializing ClearBalance...');
                
                const hasSession = await checkAuth();
                if (!hasSession) {
                    console.log('No session, stopping initialization');
                    return;
                }
                
                console.log('Loading language...');
                await loadLanguage(currentLanguage);
                
                console.log('Loading user profile...');
                await loadUserProfile();
                
                console.log('Loading accounts...');
                await loadAccounts();
                
                console.log('Populating currencies...');
                populateCurrencies();
                
                console.log('Rendering overview page...');
                renderPage('overview');
                
                console.log('Setting up event listeners...');
                setupEventListeners();
                
                console.log('‚úì ClearBalance initialized successfully!');
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                alert('Error loading dashboard: ' + error.message + '\n\nCheck console for details.');
            }
        }

        // Authentication - simple check with cookie storage
        async function checkAuth() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error) {
                console.error('Session error:', error);
            }

            if (session) {
                currentUser = session.user;
                updateProfileAvatar();
                console.log('‚úì Authenticated as:', currentUser.email);
                return true;
            } else {
                console.log('No session, redirecting to login...');
                window.location.href = 'https://clearbalance.xyz';
                return false;
            }
        }

        function updateProfileAvatar() {
            const avatar = document.getElementById('profileAvatar');
            if (currentUser.user_metadata?.avatar_url) {
                avatar.innerHTML = `<img src="${currentUser.user_metadata.avatar_url}" alt="Avatar">`;
            } else {
                avatar.textContent = currentUser.email.charAt(0).toUpperCase();
            }
        }

        // Language System
        async function loadLanguage(lang) {
            try {
                const response = await fetch(`/lang-${lang}.json`);
                translations = await response.json();
                currentLanguage = lang;
                updateUILanguage();
            } catch (error) {
                console.error('Error loading language:', error);
            }
        }

        function t(key) {
            const keys = key.split('.');
            let value = translations;
            for (const k of keys) {
                value = value?.[k];
                if (!value) return key;
            }
            return value;
        }

        function updateUILanguage() {
            // Update navigation labels
            const navItems = document.querySelectorAll('.nav-item .nav-label');
            navItems[0].textContent = t('nav.overview');
            navItems[1].textContent = t('nav.accounts');
            navItems[2].textContent = t('nav.transactions');
            navItems[3].textContent = t('nav.recurring');
            navItems[4].textContent = t('nav.subscriptions');
            navItems[5].textContent = t('nav.debts');
            navItems[6].textContent = t('nav.piggy_banks');
            navItems[7].textContent = t('nav.portfolio');
            navItems[8].textContent = t('nav.analytics');
            navItems[9].textContent = t('nav.settings');

            // Re-render current page
            renderPage(currentPage);
        }

        // Load User Profile
        async function loadUserProfile() {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (data) {
                currentLanguage = data.language || 'en';
                document.getElementById('langSelector').value = currentLanguage;
                
                if (data.dark_mode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
                }

                // Show advanced fields if advanced mode is on
                if (data.advanced_mode) {
                    document.getElementById('advancedFields').style.display = 'block';
                    document.getElementById('swiftField').style.display = 'block';
                    document.getElementById('accountNumberField').style.display = 'block';
                }
            }
        }

        // Load Accounts
        async function loadAccounts() {
            const { data, error } = await supabaseClient
                .from('accounts')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            if (data) {
                accounts = data;
                updateAccountSelector();
            }
        }

        function updateAccountSelector() {
            const selector = document.getElementById('accountSelector');
            const transactionAccountSelector = document.getElementById('transactionAccount');
            
            selector.innerHTML = '<option value="all">All Accounts</option>';
            transactionAccountSelector.innerHTML = '<option value="">Select account</option>';
            
            accounts.forEach(account => {
                const option = `<option value="${account.id}">${account.name} (${account.currency})</option>`;
                selector.innerHTML += option;
                transactionAccountSelector.innerHTML += option;
            });
        }

        function populateCurrencies() {
            const currencySelect = document.getElementById('accountCurrency');
            CURRENCIES.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                currencySelect.appendChild(option);
            });
            currencySelect.value = 'USD'; // Default
        }

        // Page Rendering
        function renderPage(page) {
            currentPage = page;
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            // Render page content
            const contentArea = document.getElementById('contentArea');
            
            switch(page) {
                case 'overview':
                    renderOverview(contentArea);
                    break;
                case 'accounts':
                    renderAccounts(contentArea);
                    break;
                case 'transactions':
                    renderTransactions(contentArea);
                    break;
                case 'recurring':
                    renderRecurring(contentArea);
                    break;
                case 'subscriptions':
                    renderSubscriptions(contentArea);
                    break;
                case 'debts':
                    renderDebts(contentArea);
                    break;
                case 'piggy-banks':
                    renderPiggyBanks(contentArea);
                    break;
                case 'portfolio':
                    renderPortfolio(contentArea);
                    break;
                case 'analytics':
                    renderAnalytics(contentArea);
                    break;
                case 'settings':
                    renderSettings(contentArea);
                    break;
            }
        }

        // OVERVIEW PAGE
        async function renderOverview(container) {
            const html = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">${t('overview.title')}</h1>
                        <p class="page-subtitle">${t('overview.subtitle')}</p>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="stat-card">
                        <div class="stat-label">${t('overview.total_balance')}</div>
                        <div class="stat-value" id="totalBalance">$0.00</div>
                        <div class="stat-change positive">
                            <span>‚Üó</span>
                            <span>This month</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">${t('overview.net_worth')}</div>
                        <div class="stat-value" id="netWorth">$0.00</div>
                        <div class="stat-change positive">
                            <span>‚Üó</span>
                            <span>All time</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">${t('overview.monthly_income')}</div>
                        <div class="stat-value" id="monthlyIncome">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">${t('overview.monthly_expenses')}</div>
                        <div class="stat-value" id="monthlyExpenses">$0.00</div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">${t('overview.recent_transactions')}</h3>
                        <button class="btn btn-primary" onclick="openModal('transactionModal')">
                            + ${t('overview.add_transaction')}
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Account</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactionsTable">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="loading"><div class="spinner"></div></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;

            // Load data
            await loadOverviewData();
        }

        async function loadOverviewData() {
            // Calculate total balance
            const { data: accountsData } = await supabaseClient
                .from('accounts')
                .select('balance, currency')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            let totalBalance = 0;
            if (accountsData) {
                totalBalance = accountsData.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
            }

            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);

            // Load recent transactions
            const { data: transactions } = await supabaseClient
                .from('transactions')
                .select('*, accounts(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false })
                .limit(10);

            if (transactions && transactions.length > 0) {
                const tbody = document.getElementById('recentTransactionsTable');
                tbody.innerHTML = transactions.map(tx => `
                    <tr>
                        <td>${formatDate(tx.date)}</td>
                        <td>${tx.description || '-'}</td>
                        <td>
                            <span class="badge badge-info">${tx.category}</span>
                        </td>
                        <td style="color: ${tx.type === 'income' ? 'var(--success)' : 'var(--error)'}; font-family: 'JetBrains Mono', monospace;">
                            ${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.amount)}
                        </td>
                        <td>${tx.accounts.name}</td>
                        <td>
                            <button class="btn-icon" onclick="deleteTransaction('${tx.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('recentTransactionsTable').innerHTML = `
                    <tr><td colspan="6">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-title">No transactions yet</div>
                            <div class="empty-state-text">Start by adding your first transaction</div>
                            <button class="btn btn-primary" onclick="openModal('transactionModal')">Add Transaction</button>
                        </div>
                    </td></tr>
                `;
            }

            // Calculate monthly stats
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const { data: monthlyTx } = await supabaseClient
                .from('transactions')
                .select('type, amount')
                .eq('user_id', currentUser.id)
                .gte('date', firstDayOfMonth.toISOString().split('T')[0]);

            let income = 0, expenses = 0;
            if (monthlyTx) {
                monthlyTx.forEach(tx => {
                    if (tx.type === 'income') income += parseFloat(tx.amount || 0);
                    else expenses += parseFloat(tx.amount || 0);
                });
            }

            document.getElementById('monthlyIncome').textContent = formatCurrency(income);
            document.getElementById('monthlyExpenses').textContent = formatCurrency(expenses);
            document.getElementById('netWorth').textContent = formatCurrency(totalBalance + income - expenses);
        }

        // ACCOUNTS PAGE
        async function renderAccounts(container) {
            const html = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">${t('accounts.title')}</h1>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('accountModal')">
                        + ${t('accounts.add_account')}
                    </button>
                </div>

                <div class="cards-grid" id="accountsGrid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            `;
            container.innerHTML = html;

            const { data } = await supabaseClient
                .from('accounts')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            const grid = document.getElementById('accountsGrid');
            if (data && data.length > 0) {
                grid.innerHTML = data.map(account => `
                    <div class="stat-card">
                        <div class="stat-label">${account.name}</div>
                        <div class="stat-value">${formatCurrency(account.balance, account.currency)}</div>
                        <div style="margin-top: 0.5rem;">
                            <span class="badge badge-info">${account.type}</span>
                            <span class="badge badge-info">${account.currency}</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn-icon" onclick="deleteAccount('${account.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí≥</div>
                        <div class="empty-state-title">No accounts yet</div>
                        <div class="empty-state-text">Add your first account to get started</div>
                        <button class="btn btn-primary" onclick="openModal('accountModal')">Add Account</button>
                    </div>
                `;
            }
        }

        // TRANSACTIONS PAGE
        async function renderTransactions(container) {
            container.innerHTML = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">${t('transactions.title')}</h1>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('transactionModal')">+ Add Transaction</button>
                </div>
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">All Transactions</h3>
                    </div>
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            `;

            const { data: transactions } = await supabaseClient
                .from('transactions')
                .select('*, accounts(name)')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            const tableContainer = container.querySelector('.data-table');
            if (transactions && transactions.length > 0) {
                tableContainer.innerHTML = `
                    <div class="table-header">
                        <h3 class="table-title">All Transactions (${transactions.length})</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Account</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.map(tx => `
                                <tr>
                                    <td>${formatDate(tx.date)}</td>
                                    <td>${tx.description || '-'}</td>
                                    <td><span class="badge badge-info">${tx.category}</span></td>
                                    <td style="color: ${tx.type === 'income' ? 'var(--success)' : 'var(--error)'}; font-family: 'JetBrains Mono';">
                                        ${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.amount)}
                                    </td>
                                    <td>${tx.accounts.name}</td>
                                    <td>
                                        <button class="btn-icon" onclick="deleteTransaction('${tx.id}')">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                tableContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <div class="empty-state-title">No transactions yet</div>
                        <button class="btn btn-primary" onclick="openModal('transactionModal')">Add Transaction</button>
                    </div>
                `;
            }
        }

        // PORTFOLIO PAGE
        async function renderPortfolio(container) {
            container.innerHTML = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">${t('portfolio.title')}</h1>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshAllPrices()" style="margin-right:0.5rem;">
                            üîÑ ${t('portfolio.refresh_prices')}
                        </button>
                        <button class="btn btn-primary" onclick="openModal('assetModal')">
                            + ${t('portfolio.add_asset')}
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="stat-card">
                        <div class="stat-label">${t('portfolio.total_value')}</div>
                        <div class="stat-value" id="totalPortfolioValue">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">${t('portfolio.total_gain_loss')}</div>
                        <div class="stat-value" id="totalGainLoss">$0.00</div>
                        <div class="stat-change" id="totalGainLossPercent"></div>
                    </div>
                </div>

                <div id="assetsContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            `;

            await loadPortfolio();
        }

        async function loadPortfolio() {
            const { data: assets } = await supabaseClient
                .from('assets')
                .select('*')
                .eq('user_id', currentUser.id);

            const assetsContainer = document.getElementById('assetsContainer');

            if (!assets || assets.length === 0) {
                assetsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <div class="empty-state-title">No assets yet</div>
                        <div class="empty-state-text">Start building your portfolio</div>
                        <button class="btn btn-primary" onclick="openModal('assetModal')">Add Asset</button>
                    </div>
                `;
                return;
            }

            let totalValue = 0;
            let totalCost = 0;

            const assetHTML = await Promise.all(assets.map(async asset => {
                let currentPrice = asset.purchase_price;
                let priceSource = 'Purchase Price';
                
                // Fetch real-time price for stocks/ETFs/crypto
                if (asset.ticker && asset.type !== 'property') {
                    const livePrice = await getStockPrice(asset.ticker);
                    if (livePrice && livePrice > 0) {
                        currentPrice = livePrice;
                        priceSource = 'Live Price';
                    }
                }

                const currentValue = currentPrice * asset.quantity;
                const costBasis = asset.purchase_price * asset.quantity;
                const gain = currentValue - costBasis;
                const gainPercent = ((gain / costBasis) * 100).toFixed(2);

                totalValue += currentValue;
                totalCost += costBasis;

                // Format ticker for display - remove exchange/currency suffix
                let displayTicker = asset.ticker || asset.type.toUpperCase();
                if (asset.ticker) {
                    // Extract clean ticker (remove .L, .DE, -USD, etc.)
                    const cleanTicker = asset.ticker.split(/[.-]/)[0];
                    
                    // Add badge for exchange/currency
                    let badge = '';
                    if (asset.type === 'crypto') {
                        const currency = asset.ticker.includes('-') ? asset.ticker.split('-')[1] : 'USD';
                        badge = `<span class="badge badge-info" style="margin-left:0.5rem;">${currency}</span>`;
                    } else if (asset.ticker.includes('.')) {
                        const exchange = asset.ticker.split('.')[1];
                        const exchangeNames = {
                            'L': 'LSE', 'DE': 'XETRA', 'PA': 'Paris', 'MI': 'Milan',
                            'AS': 'Amsterdam', 'BR': 'Brussels', 'SW': 'Swiss', 
                            'TO': 'Toronto', 'HK': 'HK', 'T': 'Tokyo'
                        };
                        badge = `<span class="badge badge-info" style="margin-left:0.5rem;">${exchangeNames[exchange] || exchange}</span>`;
                    }
                    displayTicker = cleanTicker + badge;
                }

                return `
                    <div class="asset-card">
                        <div class="asset-header">
                            <div>
                                <div class="asset-name">${asset.name}</div>
                                <div class="asset-ticker">${displayTicker}</div>
                            </div>
                            <button class="btn-icon" onclick="deleteAsset('${asset.id}')">üóëÔ∏è</button>
                        </div>
                        <div class="asset-value">${formatCurrency(currentValue)}</div>
                        <div class="asset-gain ${gain >= 0 ? 'stat-change positive' : 'stat-change negative'}">
                            <span>${gain >= 0 ? '‚Üó' : '‚Üò'}</span>
                            <span>${formatCurrency(Math.abs(gain))} (${gainPercent}%)</span>
                        </div>
                        <div style="margin-top:0.5rem; font-size:0.875rem; color:var(--secondary);">
                            ${asset.quantity} ${asset.type === 'crypto' ? 'units' : asset.type === 'property' ? 'properties' : 'shares'} @ ${formatCurrency(currentPrice)}
                            ${priceSource === 'Purchase Price' ? '<span style="color:var(--warning);"> (offline)</span>' : ''}
                        </div>
                    </div>
                `;
            }));

            assetsContainer.innerHTML = assetHTML.join('');

            // Update totals
            document.getElementById('totalPortfolioValue').textContent = formatCurrency(totalValue);
            const totalGain = totalValue - totalCost;
            const totalGainPercent = ((totalGain / totalCost) * 100).toFixed(2);
            document.getElementById('totalGainLoss').textContent = formatCurrency(Math.abs(totalGain));
            document.getElementById('totalGainLossPercent').innerHTML = `
                <span>${totalGain >= 0 ? '‚Üó' : '‚Üò'}</span>
                <span>${totalGainPercent}%</span>
            `;
            document.getElementById('totalGainLossPercent').className = `stat-change ${totalGain >= 0 ? 'positive' : 'negative'}`;
        }

        // Get stock price from Yahoo Finance (FREE!)
        // Get stock price - Using multiple free sources with CORS support
        async function getStockPrice(ticker) {
            try {
                // Method 1: Try Yahoo Finance with CORS proxy
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`;
                
                const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl));
                const data = await response.json();
                
                if (data.chart && data.chart.result && data.chart.result.length > 0) {
                    const price = data.chart.result[0].meta.regularMarketPrice;
                    if (price) return price;
                }
            } catch (error) {
                console.log('Yahoo Finance failed, trying alternative...', error);
            }

            try {
                // Method 2: Fallback to Finnhub (free, no API key for basic quotes)
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=demo`);
                const data = await response.json();
                
                if (data && data.c) {
                    return data.c; // Current price
                }
            } catch (error) {
                console.log('Finnhub failed, using purchase price...', error);
            }

            // If all methods fail, return null (will use purchase price)
            return null;
        }

        async function refreshAllPrices() {
            await loadPortfolio();
        }

        // DEBTS PAGE
        async function renderDebts(container) {
            container.innerHTML = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">${t('debts.title')}</h1>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('debtModal')">+ ${t('debts.add')}</button>
                </div>
                <div id="debtsContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            `;

            const { data: debts } = await supabaseClient
                .from('debts')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('is_active', true);

            const debtsContainer = document.getElementById('debtsContainer');

            if (!debts || debts.length === 0) {
                debtsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-title">No debts tracked</div>
                        <button class="btn btn-primary" onclick="openModal('debtModal')">Add Debt</button>
                    </div>
                `;
                return;
            }

            debtsContainer.innerHTML = debts.map(debt => {
                const progress = ((debt.principal - debt.remaining_balance) / debt.principal) * 100;
                return `
                    <div class="data-table">
                        <div class="table-header">
                            <div>
                                <h3 class="table-title">${debt.name}</h3>
                                <div style="color:var(--secondary);font-size:0.9rem;margin-top:0.25rem;">
                                    ${debt.interest_rate}% APR ‚Ä¢ ${debt.term_months} months
                                </div>
                            </div>
                            <button class="btn-icon" onclick="deleteDebt('${debt.id}')">üóëÔ∏è</button>
                        </div>
                        <div style="padding:1.5rem;">
                            <div class="cards-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <div>
                                    <div class="stat-label">Remaining Balance</div>
                                    <div class="stat-value" style="font-size:1.5rem;">${formatCurrency(debt.remaining_balance)}</div>
                                </div>
                                <div>
                                    <div class="stat-label">Monthly Payment</div>
                                    <div class="stat-value" style="font-size:1.5rem;">${formatCurrency(debt.monthly_payment)}</div>
                                </div>
                                <div>
                                    <div class="stat-label">Progress</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width:${progress}%"></div>
                                    </div>
                                    <div style="font-size:0.875rem;color:var(--secondary);margin-top:0.25rem;">
                                        ${progress.toFixed(1)}% paid off
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calculate monthly payment (amortization)
        function calculateMonthlyPayment(principal, annualRate, months) {
            const monthlyRate = annualRate / 100 / 12;
            if (monthlyRate === 0) return principal / months;
            const payment = principal * 
                (monthlyRate * Math.pow(1 + monthlyRate, months)) /
                (Math.pow(1 + monthlyRate, months) - 1);
            return payment;
        }

        // PIGGY BANKS PAGE
        async function renderPiggyBanks(container) {
            container.innerHTML = `
                <div class="page-header">
                    <div>
                        <h1 class="page-title">${t('piggy_banks.title')}</h1>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('piggyBankModal')">+ ${t('piggy_banks.add')}</button>
                </div>
                <div id="piggyBanksContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            `;

            const { data: piggyBanks } = await supabaseClient
                .from('piggy_banks')
                .select('*')
                .eq('user_id', currentUser.id);

            const container2 = document.getElementById('piggyBanksContainer');

            if (!piggyBanks || piggyBanks.length === 0) {
                container2.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üê∑</div>
                        <div class="empty-state-title">No savings goals yet</div>
                        <button class="btn btn-primary" onclick="openModal('piggyBankModal')">Create Goal</button>
                    </div>
                `;
                return;
            }

            container2.innerHTML = `<div class="cards-grid">` + piggyBanks.map(pb => {
                const progress = (pb.current_amount / pb.target_amount) * 100;
                return `
                    <div class="stat-card">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div class="stat-label">${pb.name}</div>
                            <button class="btn-icon" onclick="deletePiggyBank('${pb.id}')">üóëÔ∏è</button>
                        </div>
                        <div class="stat-value">${formatCurrency(pb.current_amount)}</div>
                        <div style="color:var(--secondary);font-size:0.875rem;margin-bottom:0.5rem;">
                            of ${formatCurrency(pb.target_amount)}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${Math.min(progress, 100)}%"></div>
                        </div>
                        <div style="margin-top:0.5rem;font-size:0.875rem;color:var(--secondary);">
                            ${progress.toFixed(1)}% complete
                        </div>
                    </div>
                `;
            }).join('') + `</div>`;
        }

        // RECURRING & SUBSCRIPTIONS (simplified)
        async function renderRecurring(container) {
            container.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">${t('recurring.title')}</h1>
                </div>
                <div class="empty-state">
                    <div class="empty-state-icon">üîÑ</div>
                    <div class="empty-state-title">Recurring Payments</div>
                    <div class="empty-state-text">Feature available in Pro version</div>
                </div>
            `;
        }

        async function renderSubscriptions(container) {
            container.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">${t('subscriptions.title')}</h1>
                </div>
                <div class="empty-state">
                    <div class="empty-state-icon">üì±</div>
                    <div class="empty-state-title">Subscriptions</div>
                    <div class="empty-state-text">Feature available in Pro version</div>
                </div>
            `;
        }

        // ANALYTICS PAGE
        async function renderAnalytics(container) {
            container.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">${t('analytics.title')}</h1>
                </div>
                <div class="chart-container" id="incomeExpenseChart"></div>
                <div class="chart-container" id="categoryChart"></div>
            `;

            await renderIncomeExpenseChart();
            await renderCategoryChart();
        }

        async function renderIncomeExpenseChart() {
            const { data: transactions } = await supabaseClient
                .from('transactions')
                .select('type, amount, date')
                .eq('user_id', currentUser.id)
                .gte('date', new Date(new Date().getFullYear(), new Date().getMonth() - 5, 1).toISOString().split('T')[0])
                .order('date', { ascending: true });

            // Group by month
            const monthlyData = {};
            transactions?.forEach(tx => {
                const month = tx.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0 };
                }
                if (tx.type === 'income') {
                    monthlyData[month].income += parseFloat(tx.amount);
                } else {
                    monthlyData[month].expense += parseFloat(tx.amount);
                }
            });

            const months = Object.keys(monthlyData).sort();
            const incomeData = months.map(m => monthlyData[m].income);
            const expenseData = months.map(m => monthlyData[m].expense);

            const options = {
                series: [{
                    name: 'Income',
                    data: incomeData
                }, {
                    name: 'Expenses',
                    data: expenseData
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    toolbar: { show: false }
                },
                colors: ['#4CAF50', '#F44336'],
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded'
                    },
                },
                dataLabels: { enabled: false },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: months.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en', { month: 'short' });
                    }),
                },
                fill: { opacity: 1 },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#incomeExpenseChart"), options);
            chart.render();
        }

        async function renderCategoryChart() {
            const { data: transactions } = await supabaseClient
                .from('transactions')
                .select('category, amount')
                .eq('user_id', currentUser.id)
                .eq('type', 'expense')
                .gte('date', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0]);

            const categoryTotals = {};
            transactions?.forEach(tx => {
                categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + parseFloat(tx.amount);
            });

            const options = {
                series: Object.values(categoryTotals),
                chart: {
                    type: 'pie',
                    height: 350
                },
                labels: Object.keys(categoryTotals),
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 200
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };

            const chart = new ApexCharts(document.querySelector("#categoryChart"), options);
            chart.render();
        }

        // SETTINGS PAGE
        async function renderSettings(container) {
            container.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">${t('settings.title')}</h1>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">${t('settings.profile')}</h3>
                    </div>
                    <div style="padding:2rem;">
                        <div class="form-group">
                            <label>${t('settings.language')}</label>
                            <select id="settingsLanguage" class="form-control">
                                <option value="en">English</option>
                                <option value="de">Deutsch</option>
                                <option value="pl">Polski</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>${t('settings.theme')}</label>
                            <select id="settingsTheme" class="form-control">
                                <option value="light">${t('settings.light')}</option>
                                <option value="dark">${t('settings.dark')}</option>
                                <option value="auto">${t('settings.auto')}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="advancedModeToggle" style="width:auto;margin-right:0.5rem;">
                                ${t('settings.advanced_mode')}
                            </label>
                            <div style="font-size:0.875rem;color:var(--secondary);margin-top:0.25rem;">
                                ${t('settings.advanced_mode_desc')}
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">${t('settings.save_changes')}</button>
                        <button class="btn btn-danger" onclick="signOut()" style="margin-left:1rem;">${t('settings.logout')}</button>
                    </div>
                </div>
            `;

            // Load current settings
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (profile) {
                document.getElementById('settingsLanguage').value = profile.language || 'en';
                document.getElementById('settingsTheme').value = profile.dark_mode ? 'dark' : 'light';
                document.getElementById('advancedModeToggle').checked = profile.advanced_mode || false;
            }
        }

        async function saveSettings() {
            const language = document.getElementById('settingsLanguage').value;
            const theme = document.getElementById('settingsTheme').value;
            const advancedMode = document.getElementById('advancedModeToggle').checked;

            await supabaseClient
                .from('profiles')
                .update({
                    language: language,
                    dark_mode: theme === 'dark',
                    advanced_mode: advancedMode
                })
                .eq('id', currentUser.id);

            // Apply changes
            await loadLanguage(language);
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('themeToggle').textContent = 'üåô';
            }

            alert('Settings saved!');
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            
            if (modalId === 'transactionModal') {
                document.getElementById('transactionDate').valueAsDate = new Date();
                loadCategories();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function loadCategories() {
            const categories = selectedTransactionType === 'expense' 
                ? Object.keys(translations.categories?.expense || {})
                : Object.keys(translations.categories?.income || {});

            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = categories.map(cat => `
                <div class="category-item" data-category="${cat}">
                    <div class="category-icon">${CATEGORY_ICONS[cat] || 'üìÅ'}</div>
                    <div class="category-label">${t(`categories.${selectedTransactionType}.${cat}`)}</div>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.category-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedCategory = this.dataset.category;
                });
            });
        }

        // Delete Functions
        async function deleteTransaction(id) {
            if (!confirm('Delete this transaction?')) return;
            await supabaseClient.from('transactions').delete().eq('id', id);
            renderPage(currentPage);
        }

        async function deleteAccount(id) {
            if (!confirm('Delete this account? This will also delete all associated transactions.')) return;
            await supabaseClient.from('accounts').update({ is_active: false }).eq('id', id);
            await loadAccounts();
            renderPage(currentPage);
        }

        async function deleteAsset(id) {
            if (!confirm('Delete this asset?')) return;
            await supabaseClient.from('assets').delete().eq('id', id);
            renderPage(currentPage);
        }

        async function deleteDebt(id) {
            if (!confirm('Delete this debt?')) return;
            await supabaseClient.from('debts').update({ is_active: false }).eq('id', id);
            renderPage(currentPage);
        }

        async function deletePiggyBank(id) {
            if (!confirm('Delete this savings goal?')) return;
            await supabaseClient.from('piggy_banks').delete().eq('id', id);
            renderPage(currentPage);
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    renderPage(item.dataset.page);
                });
            });

            // Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                
                supabaseClient.from('profiles').update({ dark_mode: isDark }).eq('id', currentUser.id);
            });

            // Language Selector
            document.getElementById('langSelector').addEventListener('change', (e) => {
                loadLanguage(e.target.value);
                supabaseClient.from('profiles').update({ language: e.target.value }).eq('id', currentUser.id);
            });

            // Transaction Type Toggle
            document.querySelectorAll('.type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedTransactionType = this.dataset.type;
                    document.getElementById('transactionType').value = selectedTransactionType;
                    loadCategories();
                });
            });

            // Transaction Form Submit
            document.getElementById('transactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!selectedCategory) {
                    alert('Please select a category');
                    return;
                }

                const formData = {
                    user_id: currentUser.id,
                    account_id: document.getElementById('transactionAccount').value,
                    type: selectedTransactionType,
                    category: selectedCategory,
                    amount: parseFloat(document.getElementById('transactionAmount').value),
                    date: document.getElementById('transactionDate').value,
                    description: document.getElementById('transactionDescription').value
                };

                const { error } = await supabaseClient.from('transactions').insert([formData]);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    closeModal('transactionModal');
                    renderPage(currentPage);
                    e.target.reset();
                    selectedCategory = null;
                }
            });

            // Account Form Submit
            document.getElementById('accountForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    user_id: currentUser.id,
                    name: document.getElementById('accountName').value,
                    type: document.getElementById('accountType').value,
                    currency: document.getElementById('accountCurrency').value,
                    balance: parseFloat(document.getElementById('accountBalance').value),
                    iban: document.getElementById('accountIban').value,
                    swift: document.getElementById('accountSwift').value,
                    account_number: document.getElementById('accountNumber').value
                };

                const { error } = await supabaseClient.from('accounts').insert([formData]);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    closeModal('accountModal');
                    await loadAccounts();
                    renderPage(currentPage);
                    e.target.reset();
                }
            });

            // Asset Type Handler - Dynamic form fields
            document.getElementById('assetType').addEventListener('change', function() {
                const assetType = this.value;
                const tickerField = document.getElementById('tickerField');
                const exchangeField = document.getElementById('exchangeField');
                const cryptoCurrencyField = document.getElementById('cryptoCurrencyField');
                const tickerLabel = document.getElementById('tickerLabel');
                const tickerInput = document.getElementById('assetTicker');
                const quantityLabel = document.getElementById('quantityLabel');
                const priceLabel = document.getElementById('priceLabel');

                // Reset all fields
                exchangeField.style.display = 'none';
                cryptoCurrencyField.style.display = 'none';
                tickerField.style.display = 'block';
                tickerInput.required = true;

                if (assetType === 'stock') {
                    tickerLabel.textContent = 'Ticker Symbol';
                    tickerInput.placeholder = 'AAPL';
                    exchangeField.style.display = 'block';
                    quantityLabel.textContent = 'Quantity/Shares';
                    priceLabel.textContent = 'Purchase Price per Share';
                } else if (assetType === 'etf') {
                    tickerLabel.textContent = 'ETF Symbol';
                    tickerInput.placeholder = 'SPY';
                    exchangeField.style.display = 'block';
                    quantityLabel.textContent = 'Quantity/Shares';
                    priceLabel.textContent = 'Purchase Price per Share';
                } else if (assetType === 'crypto') {
                    tickerLabel.textContent = 'Crypto Symbol';
                    tickerInput.placeholder = 'BTC';
                    cryptoCurrencyField.style.display = 'block';
                    quantityLabel.textContent = 'Amount';
                    priceLabel.textContent = 'Purchase Price per Unit';
                } else if (assetType === 'property') {
                    tickerField.style.display = 'none';
                    tickerInput.required = false;
                    tickerInput.value = '';
                    quantityLabel.textContent = 'Units/Properties';
                    priceLabel.textContent = 'Purchase Price per Unit';
                }
            });

            // Auto-detect currency from crypto ticker
            document.getElementById('assetTicker').addEventListener('input', function() {
                const assetType = document.getElementById('assetType').value;
                if (assetType === 'crypto') {
                    const ticker = this.value.toUpperCase();
                    const cryptoCurrencySelect = document.getElementById('cryptoCurrency');
                    
                    // Check if ticker contains currency suffix
                    if (ticker.includes('-USD')) {
                        cryptoCurrencySelect.value = 'USD';
                        this.value = ticker.replace('-USD', '');
                    } else if (ticker.includes('-EUR')) {
                        cryptoCurrencySelect.value = 'EUR';
                        this.value = ticker.replace('-EUR', '');
                    } else if (ticker.includes('-GBP')) {
                        cryptoCurrencySelect.value = 'GBP';
                        this.value = ticker.replace('-GBP', '');
                    } else if (ticker.includes('-JPY')) {
                        cryptoCurrencySelect.value = 'JPY';
                        this.value = ticker.replace('-JPY', '');
                    } else if (ticker.includes('-PLN')) {
                        cryptoCurrencySelect.value = 'PLN';
                        this.value = ticker.replace('-PLN', '');
                    }
                }
            });

            // Asset Form Submit
            document.getElementById('assetForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const assetType = document.getElementById('assetType').value;
                let ticker = document.getElementById('assetTicker').value.trim().toUpperCase();

                // Build proper ticker based on asset type
                if (assetType === 'stock' || assetType === 'etf') {
                    const exchange = document.getElementById('assetExchange').value;
                    if (exchange) {
                        ticker = `${ticker}.${exchange}`;
                    }
                } else if (assetType === 'crypto') {
                    const currency = document.getElementById('cryptoCurrency').value;
                    // Only add suffix if not already present
                    if (!ticker.includes('-')) {
                        ticker = `${ticker}-${currency}`;
                    }
                } else if (assetType === 'property') {
                    ticker = null; // No ticker for real estate
                }

                const formData = {
                    user_id: currentUser.id,
                    type: assetType,
                    ticker: ticker,
                    name: document.getElementById('assetName').value,
                    quantity: parseFloat(document.getElementById('assetQuantity').value),
                    purchase_price: parseFloat(document.getElementById('assetPurchasePrice').value),
                    purchase_date: document.getElementById('assetPurchaseDate').value
                };

                const { error } = await supabaseClient.from('assets').insert([formData]);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    closeModal('assetModal');
                    renderPage(currentPage);
                    e.target.reset();
                    // Reset form to default state
                    document.getElementById('exchangeField').style.display = 'none';
                    document.getElementById('cryptoCurrencyField').style.display = 'none';
                    document.getElementById('tickerField').style.display = 'block';
                }
            });

            // Debt Form Submit
            document.getElementById('debtForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const principal = parseFloat(document.getElementById('debtPrincipal').value);
                const interestRate = parseFloat(document.getElementById('debtInterestRate').value);
                const termMonths = parseInt(document.getElementById('debtTermMonths').value);
                
                const monthlyPayment = calculateMonthlyPayment(principal, interestRate, termMonths);

                const formData = {
                    user_id: currentUser.id,
                    name: document.getElementById('debtName').value,
                    principal: principal,
                    interest_rate: interestRate,
                    term_months: termMonths,
                    payment_day: parseInt(document.getElementById('debtPaymentDay').value),
                    start_date: document.getElementById('debtStartDate').value,
                    monthly_payment: monthlyPayment,
                    remaining_balance: principal
                };

                const { error } = await supabaseClient.from('debts').insert([formData]);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    closeModal('debtModal');
                    renderPage(currentPage);
                    e.target.reset();
                }
            });

            // Piggy Bank Form Submit
            document.getElementById('piggyBankForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    user_id: currentUser.id,
                    name: document.getElementById('piggyBankName').value,
                    target_amount: parseFloat(document.getElementById('piggyBankTarget').value),
                    current_amount: parseFloat(document.getElementById('piggyBankCurrent').value),
                    deadline: document.getElementById('piggyBankDeadline').value || null
                };

                const { error } = await supabaseClient.from('piggy_banks').insert([formData]);

                if (error) {
                    alert('Error: ' + error.message);
                } else {
                    closeModal('piggyBankModal');
                    renderPage(currentPage);
                    e.target.reset();
                }
            });
        }

        // Utility Functions
        function formatCurrency(amount, currency = 'USD') {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }).format(date);
        }

        async function signOut() {
            // Clear cookie storage
            cookieStorage.removeItem('cb-auth-token');
            sessionStorage.clear();
            
            await supabaseClient.auth.signOut();
            window.location.href = 'https://clearbalance.xyz';
        }

        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_OUT') {
                sessionStorage.clear();
                window.location.href = 'https://clearbalance.xyz';
            } else if (event === 'TOKEN_REFRESHED') {
                console.log('Token refreshed successfully');
            } else if (event === 'SIGNED_IN' && !currentUser) {
                // User just signed in
                currentUser = session.user;
                updateProfileAvatar();
            }
        });

        // Initialize on load
        initApp();
    </script>
</body>
</html>
