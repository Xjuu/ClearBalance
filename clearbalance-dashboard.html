<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClearBalance - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-900: #111827;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }

    .hidden { display: none !important; }

    /* Cookie Banner */
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 1.5rem;
      box-shadow: var(--shadow-lg);
      z-index: 9999;
      border-top: 2px solid var(--primary);
    }

    .cookie-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }

    .cookie-text {
      flex: 1;
      font-size: 0.9rem;
      color: var(--gray-600);
    }

    .btn {
      padding: 0.625rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    /* Top Nav */
    .top-nav {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    .nav-container {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .lang-switcher {
      display: flex;
      gap: 0.5rem;
      background: var(--gray-100);
      padding: 0.25rem;
      border-radius: 0.5rem;
    }

    .lang-btn {
      padding: 0.375rem 0.75rem;
      background: transparent;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--gray-600);
      transition: all 0.2s;
    }

    .lang-btn.active {
      background: white;
      color: var(--primary);
      box-shadow: var(--shadow);
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
    }

    .btn-logout {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    .btn-logout:hover {
      background: var(--gray-100);
    }

    /* Layout */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 2rem;
    }

    /* Sidebar */
    .sidebar {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      height: fit-content;
      position: sticky;
      top: 90px;
      box-shadow: var(--shadow);
    }

    .nav-menu {
      list-style: none;
    }

    .nav-item {
      margin-bottom: 0.25rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--gray-700);
      font-weight: 500;
      font-size: 0.875rem;
    }

    .nav-link:hover {
      background: var(--gray-100);
    }

    .nav-link.active {
      background: var(--primary);
      color: white;
    }

    /* Main Content */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }

    .stat-card.income {
      border-left-color: var(--success);
    }

    .stat-card.expense {
      border-left-color: var(--danger);
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-600);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.875rem;
      font-weight: 800;
      color: var(--gray-900);
    }

    .stat-change {
      font-size: 0.75rem;
      color: var(--gray-600);
      margin-top: 0.5rem;
    }

    /* Card */
    .card {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Forms */
    .form-grid {
      display: grid;
      gap: 1rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--gray-700);
    }

    input, select, textarea {
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-family: inherit;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      opacity: 0.9;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
    }

    /* Data List */
    .data-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 500px;
      overflow-y: auto;
    }

    .data-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 1rem;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 0.5rem;
      align-items: center;
      transition: all 0.2s;
    }

    .data-item:hover {
      background: var(--gray-100);
    }

    .item-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      background: white;
    }

    .item-icon.income {
      background: var(--success);
      color: white;
    }

    .item-icon.expense {
      background: var(--danger);
      color: white;
    }

    .item-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .item-title {
      font-weight: 600;
      color: var(--gray-900);
    }

    .item-meta {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .item-amount {
      font-size: 1.25rem;
      font-weight: 700;
      text-align: right;
    }

    .item-amount.positive {
      color: var(--success);
    }

    .item-amount.negative {
      color: var(--danger);
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--gray-600);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Info Box */
    .info-box {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--gray-100);
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
    }

    .info-label {
      color: var(--gray-600);
    }

    .info-value {
      font-weight: 600;
      color: var(--gray-900);
    }

    /* Progress Bar */
    .progress-container {
      margin: 1rem 0;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 0.5rem;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
    }

    .progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s;
    }

    .progress-fill.over {
      background: var(--danger);
    }

    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
      }
      .chart-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .data-item {
        grid-template-columns: auto 1fr;
      }
      .cookie-content {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Cookie Banner -->
  <div id="cookieBanner" class="cookie-banner hidden">
    <div class="cookie-content">
      <p class="cookie-text">
        We use only essential cookies to keep you logged in. No tracking or ads.
      </p>
      <button class="btn btn-primary" onclick="acceptCookies()">Accept</button>
    </div>
  </div>

  <!-- Top Nav -->
  <nav class="top-nav">
    <div class="nav-container">
      <div class="logo">ClearBalance</div>
      <div class="nav-right">
        <div class="lang-switcher">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="de">DE</button>
          <button class="lang-btn" data-lang="fr">FR</button>
          <button class="lang-btn" data-lang="pl">PL</button>
          <button class="lang-btn" data-lang="es">ES</button>
          <button class="lang-btn" data-lang="it">IT</button>
        </div>
        <div class="user-section">
          <div class="user-avatar" id="userAvatar">U</div>
          <span id="userName" style="font-size: 0.875rem; font-weight: 600;">User</span>
        </div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <ul class="nav-menu">
          <li class="nav-item">
            <div class="nav-link active" data-section="dashboard">
              <span>üìä</span>
              <span>Dashboard</span>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link" data-section="accounts">
              <span>üè¶</span>
              <span>Accounts</span>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link" data-section="transactions">
              <span>üí∏</span>
              <span>Transactions</span>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link" data-section="portfolio">
              <span>üìà</span>
              <span>Portfolio</span>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link" data-section="debts">
              <span>üí≥</span>
              <span>Debts</span>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link" data-section="recurring">
              <span>üîÑ</span>
              <span>Recurring</span>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link" data-section="budgets">
              <span>üéØ</span>
              <span>Budgets</span>
            </div>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard -->
        <section id="dashboard" class="section active">
          <div class="stats-grid">
            <div class="stat-card income">
              <div class="stat-label">Total Income</div>
              <div class="stat-value" id="totalIncome">$0.00</div>
              <div class="stat-change">This month</div>
            </div>
            <div class="stat-card expense">
              <div class="stat-label">Total Expenses</div>
              <div class="stat-value" id="totalExpenses">$0.00</div>
              <div class="stat-change">This month</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Net Worth</div>
              <div class="stat-value" id="netWorth">$0.00</div>
              <div class="stat-change">All accounts</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Savings Rate</div>
              <div class="stat-value" id="savingsRate">0%</div>
              <div class="stat-change">This month</div>
            </div>
          </div>

          <div class="chart-grid">
            <div class="card">
              <h2 class="card-title"><span>üìä</span> Income vs Expenses</h2>
              <div class="chart-container">
                <canvas id="incomeExpenseChart"></canvas>
              </div>
            </div>
            <div class="card">
              <h2 class="card-title"><span>ü•ß</span> Spending by Category</h2>
              <div class="chart-container">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Accounts -->
        <section id="accounts" class="section">
          <div class="card">
            <h2 class="card-title"><span>üè¶</span> Add Account</h2>
            <form id="accountForm" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label>Account Name *</label>
                  <input type="text" id="accountName" required>
                </div>
                <div class="form-group">
                  <label>Account Type *</label>
                  <select id="accountType" required>
                    <option value="personal">Personal</option>
                    <option value="business">Business</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Currency *</label>
                  <select id="accountCurrency" required></select>
                </div>
                <div class="form-group">
                  <label>Initial Balance *</label>
                  <input type="number" id="accountBalance" step="0.01" required>
                </div>
              </div>
              <button type="submit" class="btn btn-success">Add Account</button>
            </form>
          </div>

          <div class="card">
            <h2 class="card-title"><span>üí∞</span> Your Accounts</h2>
            <div id="accountsList" class="data-list"></div>
          </div>
        </section>

        <!-- Transactions -->
        <section id="transactions" class="section">
          <div class="card">
            <h2 class="card-title"><span>üí∏</span> Add Transaction</h2>
            <form id="transactionForm" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label>Description *</label>
                  <input type="text" id="transDescription" required>
                </div>
                <div class="form-group">
                  <label>Amount *</label>
                  <input type="number" id="transAmount" step="0.01" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Type *</label>
                  <select id="transType" required>
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Category *</label>
                  <select id="transCategory" required></select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Account</label>
                  <select id="transAccount"></select>
                </div>
                <div class="form-group">
                  <label>Date *</label>
                  <input type="date" id="transDate" required>
                </div>
              </div>
              <button type="submit" class="btn btn-success">Add Transaction</button>
            </form>
          </div>

          <div class="card">
            <h2 class="card-title"><span>üìã</span> Transaction History</h2>
            <div id="transactionsList" class="data-list"></div>
          </div>
        </section>

        <!-- Portfolio -->
        <section id="portfolio" class="section">
          <div class="card">
            <h2 class="card-title"><span>üìà</span> Add Investment</h2>
            <form id="portfolioForm" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label>Asset Type *</label>
                  <select id="assetType" required>
                    <option value="stock">Stock/ETF</option>
                    <option value="crypto">Cryptocurrency</option>
                    <option value="property">Real Estate</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Symbol/Ticker *</label>
                  <input type="text" id="assetSymbol" required placeholder="AAPL, BTC-USD">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Quantity *</label>
                  <input type="number" id="assetQuantity" step="0.000001" required>
                </div>
                <div class="form-group">
                  <label>Purchase Price *</label>
                  <input type="number" id="purchasePrice" step="0.01" required>
                </div>
              </div>
              <div id="stockPricePreview" class="info-box hidden"></div>
              <button type="submit" class="btn btn-success">Add to Portfolio</button>
            </form>
          </div>

          <div class="card">
            <h2 class="card-title"><span>üíº</span> Your Portfolio</h2>
            <div class="stats-grid" style="margin-bottom: 1rem;">
              <div class="stat-card">
                <div class="stat-label">Total Value</div>
                <div class="stat-value" id="portfolioTotalValue">$0.00</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Gain/Loss</div>
                <div class="stat-value" id="portfolioTotalGain">$0.00</div>
              </div>
            </div>
            <div id="portfolioList" class="data-list"></div>
          </div>
        </section>

        <!-- Debts -->
        <section id="debts" class="section">
          <div class="card">
            <h2 class="card-title"><span>üí≥</span> Add Debt</h2>
            <form id="debtForm" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label>Debt Name *</label>
                  <input type="text" id="debtName" required>
                </div>
                <div class="form-group">
                  <label>Debt Type *</label>
                  <select id="debtType" required>
                    <option value="credit_card">Credit Card</option>
                    <option value="personal_loan">Personal Loan</option>
                    <option value="mortgage">Mortgage</option>
                    <option value="student_loan">Student Loan</option>
                    <option value="car_loan">Car Loan</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Current Balance *</label>
                  <input type="number" id="debtBalance" step="0.01" required>
                </div>
                <div class="form-group">
                  <label>Interest Rate (%) *</label>
                  <input type="number" id="interestRate" step="0.01" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Monthly Payment *</label>
                  <input type="number" id="monthlyPayment" step="0.01" required>
                </div>
                <div class="form-group">
                  <label>Currency *</label>
                  <select id="debtCurrency" required></select>
                </div>
              </div>
              <div id="debtPayoffPreview" class="info-box hidden"></div>
              <button type="submit" class="btn btn-success">Add Debt</button>
            </form>
          </div>

          <div class="card">
            <h2 class="card-title"><span>üìâ</span> Your Debts</h2>
            <div id="debtsList" class="data-list"></div>
          </div>
        </section>

        <!-- Recurring -->
        <section id="recurring" class="section">
          <div class="card">
            <h2 class="card-title"><span>üîÑ</span> Add Recurring Payment</h2>
            <form id="recurringForm" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label>Name *</label>
                  <input type="text" id="recurringName" required>
                </div>
                <div class="form-group">
                  <label>Amount *</label>
                  <input type="number" id="recurringAmount" step="0.01" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Frequency *</label>
                  <select id="recurringFrequency" required>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Next Due Date *</label>
                  <input type="date" id="nextDueDate" required>
                </div>
              </div>
              <button type="submit" class="btn btn-success">Add Recurring Payment</button>
            </form>
          </div>

          <div class="card">
            <h2 class="card-title"><span>üìÖ</span> Your Subscriptions</h2>
            <div id="recurringList" class="data-list"></div>
          </div>
        </section>

        <!-- Budgets -->
        <section id="budgets" class="section">
          <div class="card">
            <h2 class="card-title"><span>üéØ</span> Set Budget Goal</h2>
            <form id="budgetForm" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label>Category *</label>
                  <select id="budgetCategory" required>
                    <option value="groceries">Groceries</option>
                    <option value="restaurants">Restaurants</option>
                    <option value="transportation">Transportation</option>
                    <option value="entertainment">Entertainment</option>
                    <option value="shopping">Shopping</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Budget Limit *</label>
                  <input type="number" id="budgetLimit" step="0.01" required>
                </div>
              </div>
              <button type="submit" class="btn btn-success">Set Budget</button>
            </form>
          </div>

          <div class="card">
            <h2 class="card-title"><span>üìä</span> Budget Progress</h2>
            <div id="budgetsList"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <script>
    // Configuration
    const SUPABASE_URL = 'https://myapdqurgspzlhmutkeq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15YXBkcXVyZ3NwemxobXV0a2VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTQ2NTksImV4cCI6MjA4NjIzMDY1OX0.T4Doyc26Led9dFZu6eQ6FiZv7mZdBd6nx17PW2-05ck';

    const currencies = {
      PLN: {symbol: "z≈Ç"}, USD: {symbol: "$"}, EUR: {symbol: "‚Ç¨"}, GBP: {symbol: "¬£"},
      JPY: {symbol: "¬•"}, CHF: {symbol: "CHF"}, CAD: {symbol: "C$"}, AUD: {symbol: "A$"}
    };

    const incomeCategories = [
      {value: 'salary', label: 'Salary'},
      {value: 'freelance', label: 'Freelance'},
      {value: 'investment', label: 'Investment'},
      {value: 'business', label: 'Business'},
      {value: 'other_income', label: 'Other Income'}
    ];

    const expenseCategories = [
      {value: 'groceries', label: 'Groceries'},
      {value: 'restaurants', label: 'Restaurants'},
      {value: 'transportation', label: 'Transportation'},
      {value: 'utilities', label: 'Utilities'},
      {value: 'entertainment', label: 'Entertainment'},
      {value: 'shopping', label: 'Shopping'},
      {value: 'healthcare', label: 'Healthcare'},
      {value: 'education', label: 'Education'},
      {value: 'other', label: 'Other'}
    ];

    let currentUser = null;
    let userCurrency = 'USD';
    let supabaseClient;
    let accounts = [];
    let transactions = [];
    let portfolio = [];
    let debts = [];
    let recurring = [];
    let budgets = [];
    let charts = {};

    // Cookie Consent
    function acceptCookies() {
      localStorage.setItem('cookieConsent', 'true');
      document.getElementById('cookieBanner').classList.add('hidden');
    }

    function checkCookieConsent() {
      if (!localStorage.getItem('cookieConsent')) {
        document.getElementById('cookieBanner').classList.remove('hidden');
      }
    }

    // Language Switcher
    function setupLanguage() {
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          localStorage.setItem('userLanguage', btn.dataset.lang);
        });
      });

      const savedLang = localStorage.getItem('userLanguage');
      if (savedLang) {
        document.querySelector('[data-lang="en"]').classList.remove('active');
        document.querySelector('[data-lang="' + savedLang + '"]').classList.add('active');
      }
    }

    // Initialize
    async function init() {
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

      const { data: { session } } = await supabaseClient.auth.getSession();
      
      if (!session) {
        window.location.replace('clearbalance-landing.html');
        return;
      }

      currentUser = session.user;
      
      checkCookieConsent();
      setupLanguage();

      document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();
      document.getElementById('userName').textContent = currentUser.email.split('@')[0];

      const { data: profile } = await supabaseClient
        .from('user_profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (profile) {
        userCurrency = profile.primary_currency || 'USD';
      }

      populateCurrencySelects();
      setDefaultDates();
      updateCategoryOptions();

      document.getElementById('transType').addEventListener('change', updateCategoryOptions);
      document.getElementById('assetSymbol').addEventListener('blur', fetchStockPrice);
      
      ['debtBalance', 'interestRate', 'monthlyPayment'].forEach(id => {
        document.getElementById(id).addEventListener('input', calculateDebtPayoff);
      });

      await loadAllData();
      setupEventListeners();
      setupNavigation();
      renderDashboard();
    }

    function populateCurrencySelects() {
      ['accountCurrency', 'debtCurrency'].forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '';
        Object.keys(currencies).forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          if (code === userCurrency) option.selected = true;
          select.appendChild(option);
        });
      });
    }

    function setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('transDate').value = today;
      document.getElementById('nextDueDate').value = today;
    }

    function updateCategoryOptions() {
      const type = document.getElementById('transType').value;
      const categorySelect = document.getElementById('transCategory');
      categorySelect.innerHTML = '';
      
      const categories = type === 'income' ? incomeCategories : expenseCategories;
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.value;
        option.textContent = cat.label;
        categorySelect.appendChild(option);
      });
    }

    async function fetchStockPrice() {
      const symbol = document.getElementById('assetSymbol').value.trim().toUpperCase();
      const preview = document.getElementById('stockPricePreview');
      
      if (!symbol) {
        preview.classList.add('hidden');
        return;
      }

      preview.innerHTML = 'Loading price...';
      preview.classList.remove('hidden');

      try {
        const response = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/' + symbol);
        const data = await response.json();
        
        if (data.chart.result && data.chart.result[0]) {
          const result = data.chart.result[0];
          const currentPrice = result.meta.regularMarketPrice;
          const previousClose = result.meta.chartPreviousClose;
          const change = currentPrice - previousClose;
          const changePercent = (change / previousClose * 100).toFixed(2);
          
          preview.innerHTML = '<div class="info-row"><span class="info-label">Current Price:</span><span class="info-value">$' + currentPrice.toFixed(2) + ' (' + (change >= 0 ? '+' : '') + changePercent + '%)</span></div>';
        } else {
          preview.innerHTML = 'Could not fetch price';
        }
      } catch (error) {
        preview.innerHTML = 'Could not fetch price';
      }
    }

    function calculateDebtPayoff() {
      const balance = parseFloat(document.getElementById('debtBalance').value) || 0;
      const rate = parseFloat(document.getElementById('interestRate').value) || 0;
      const payment = parseFloat(document.getElementById('monthlyPayment').value) || 0;
      const preview = document.getElementById('debtPayoffPreview');

      if (!balance || !payment) {
        preview.classList.add('hidden');
        return;
      }

      const monthlyRate = (rate / 100) / 12;
      
      if (payment <= balance * monthlyRate) {
        preview.innerHTML = '<div class="info-value" style="color: var(--danger)">Payment too small!</div>';
        preview.classList.remove('hidden');
        return;
      }

      const months = Math.ceil(-Math.log(1 - (balance * monthlyRate) / payment) / Math.log(1 + monthlyRate));
      const totalInterest = (payment * months) - balance;
      const payoffDate = new Date();
      payoffDate.setMonth(payoffDate.getMonth() + months);

      preview.innerHTML = '<div class="info-row"><span class="info-label">Payoff Date:</span><span class="info-value">' + payoffDate.toLocaleDateString() + '</span></div><div class="info-row"><span class="info-label">Total Interest:</span><span class="info-value">$' + totalInterest.toFixed(2) + '</span></div>';
      preview.classList.remove('hidden');
    }

    function getCurrencySymbol(code) {
      return currencies[code]?.symbol || code;
    }

    function formatCurrency(amount, currencyCode) {
      return getCurrencySymbol(currencyCode) + amount.toFixed(2);
    }

    async function loadAllData() {
      await Promise.all([
        loadAccounts(),
        loadTransactions(),
        loadPortfolio(),
        loadDebts(),
        loadRecurring(),
        loadBudgets()
      ]);
    }

    async function loadAccounts() {
      const { data } = await supabaseClient.from('bank_accounts').select('*').eq('user_id', currentUser.id).eq('is_active', true);
      accounts = data || [];
      renderAccounts();
      populateAccountSelects();
    }

    async function loadTransactions() {
      const { data } = await supabaseClient.from('transactions').select('*').eq('user_id', currentUser.id).order('date', { ascending: false }).limit(100);
      transactions = data || [];
      renderTransactions();
    }

    async function loadPortfolio() {
      const { data } = await supabaseClient.from('portfolio_assets').select('*').eq('user_id', currentUser.id);
      portfolio = data || [];
      renderPortfolio();
    }

    async function loadDebts() {
      const { data } = await supabaseClient.from('debts').select('*').eq('user_id', currentUser.id).eq('is_active', true);
      debts = data || [];
      renderDebts();
    }

    async function loadRecurring() {
      const { data } = await supabaseClient.from('recurring_payments').select('*').eq('user_id', currentUser.id).eq('is_active', true);
      recurring = data || [];
      renderRecurring();
    }

    async function loadBudgets() {
      const { data } = await supabaseClient.from('budget_goals').select('*').eq('user_id', currentUser.id).eq('is_active', true);
      budgets = data || [];
      renderBudgets();
    }

    function setupNavigation() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          
          link.classList.add('active');
          document.getElementById(link.dataset.section).classList.add('active');
        });
      });
    }

    function setupEventListeners() {
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = 'clearbalance-landing.html';
      });

      document.getElementById('accountForm').addEventListener('submit', addAccount);
      document.getElementById('transactionForm').addEventListener('submit', addTransaction);
      document.getElementById('portfolioForm').addEventListener('submit', addPortfolioAsset);
      document.getElementById('debtForm').addEventListener('submit', addDebt);
      document.getElementById('recurringForm').addEventListener('submit', addRecurring);
      document.getElementById('budgetForm').addEventListener('submit', addBudget);
    }

    async function addAccount(e) {
      e.preventDefault();
      const account = {
        user_id: currentUser.id,
        name: document.getElementById('accountName').value,
        account_type: document.getElementById('accountType').value,
        currency: document.getElementById('accountCurrency').value,
        balance: parseFloat(document.getElementById('accountBalance').value)
      };

      await supabaseClient.from('bank_accounts').insert([account]);
      e.target.reset();
      await loadAccounts();
      renderDashboard();
    }

    function renderAccounts() {
      const list = document.getElementById('accountsList');
      if (accounts.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üè¶</div><p>No accounts yet</p></div>';
        return;
      }

      list.innerHTML = accounts.map(acc => {
        return '<div class="data-item"><div class="item-icon">' + (acc.account_type === 'business' ? 'üè¢' : 'üë§') + '</div><div class="item-details"><div class="item-title">' + acc.name + '</div><div class="item-meta">' + acc.account_type + '</div></div><div class="item-amount positive">' + formatCurrency(acc.balance, acc.currency) + '</div><button class="btn btn-danger" onclick="deleteAccount(' + acc.id + ')">Delete</button></div>';
      }).join('');
    }

    function populateAccountSelects() {
      const select = document.getElementById('transAccount');
      select.innerHTML = '<option value="">Select account...</option>';
      accounts.forEach(acc => {
        const option = document.createElement('option');
        option.value = acc.id;
        option.textContent = acc.name;
        select.appendChild(option);
      });
    }

    async function deleteAccount(id) {
      if (!confirm('Delete this account?')) return;
      await supabaseClient.from('bank_accounts').delete().eq('id', id);
      await loadAccounts();
      renderDashboard();
    }

    async function addTransaction(e) {
      e.preventDefault();
      const accountId = document.getElementById('transAccount').value;
      const transaction = {
        user_id: currentUser.id,
        account_id: accountId || null,
        description: document.getElementById('transDescription').value,
        amount: parseFloat(document.getElementById('transAmount').value),
        type: document.getElementById('transType').value,
        category: document.getElementById('transCategory').value,
        date: document.getElementById('transDate').value
      };

      await supabaseClient.from('transactions').insert([transaction]);
      e.target.reset();
      setDefaultDates();
      updateCategoryOptions();
      await loadTransactions();
      await loadAccounts();
      renderDashboard();
    }

    function renderTransactions() {
      const list = document.getElementById('transactionsList');
      if (transactions.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∏</div><p>No transactions yet</p></div>';
        return;
      }

      list.innerHTML = transactions.slice(0, 50).map(t => {
        const account = accounts.find(a => a.id === t.account_id);
        const currency = account?.currency || userCurrency;
        return '<div class="data-item"><div class="item-icon ' + t.type + '">' + (t.type === 'income' ? 'üí∞' : 'üí∏') + '</div><div class="item-details"><div class="item-title">' + t.description + '</div><div class="item-meta">' + t.category + ' ‚Ä¢ ' + new Date(t.date).toLocaleDateString() + '</div></div><div class="item-amount ' + (t.type === 'income' ? 'positive' : 'negative') + '">' + (t.type === 'income' ? '+' : '-') + formatCurrency(t.amount, currency) + '</div><button class="btn btn-danger" onclick="deleteTransaction(' + t.id + ')">Delete</button></div>';
      }).join('');
    }

    async function deleteTransaction(id) {
      if (!confirm('Delete?')) return;
      await supabaseClient.from('transactions').delete().eq('id', id);
      await loadTransactions();
      await loadAccounts();
      renderDashboard();
    }

    async function addPortfolioAsset(e) {
      e.preventDefault();
      const asset = {
        user_id: currentUser.id,
        asset_type: document.getElementById('assetType').value,
        symbol: document.getElementById('assetSymbol').value.toUpperCase(),
        name: document.getElementById('assetSymbol').value.toUpperCase(),
        quantity: parseFloat(document.getElementById('assetQuantity').value),
        purchase_price: parseFloat(document.getElementById('purchasePrice').value),
        currency: userCurrency,
        purchase_date: new Date().toISOString().split('T')[0]
      };

      await supabaseClient.from('portfolio_assets').insert([asset]);
      e.target.reset();
      document.getElementById('stockPricePreview').classList.add('hidden');
      await loadPortfolio();
      renderDashboard();
    }

    function renderPortfolio() {
      const list = document.getElementById('portfolioList');
      if (portfolio.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìà</div><p>No investments yet</p></div>';
        document.getElementById('portfolioTotalValue').textContent = '$0.00';
        document.getElementById('portfolioTotalGain').textContent = '$0.00';
        return;
      }

      let totalValue = 0;
      let totalCost = 0;

      list.innerHTML = portfolio.map(asset => {
        const purchaseValue = asset.quantity * asset.purchase_price;
        const currentValue = asset.quantity * (asset.current_price || asset.purchase_price);
        const gain = currentValue - purchaseValue;
        totalValue += currentValue;
        totalCost += purchaseValue;

        return '<div class="data-item"><div class="item-icon">üìä</div><div class="item-details"><div class="item-title">' + asset.symbol + '</div><div class="item-meta">' + asset.quantity + ' units</div></div><div class="item-amount ' + (gain >= 0 ? 'positive' : 'negative') + '">' + formatCurrency(currentValue, asset.currency) + '</div><button class="btn btn-danger" onclick="deleteAsset(' + asset.id + ')">Delete</button></div>';
      }).join('');

      document.getElementById('portfolioTotalValue').textContent = formatCurrency(totalValue, userCurrency);
      document.getElementById('portfolioTotalGain').textContent = formatCurrency(totalValue - totalCost, userCurrency);
    }

    async function deleteAsset(id) {
      if (!confirm('Delete?')) return;
      await supabaseClient.from('portfolio_assets').delete().eq('id', id);
      await loadPortfolio();
      renderDashboard();
    }

    async function addDebt(e) {
      e.preventDefault();
      const debt = {
        user_id: currentUser.id,
        name: document.getElementById('debtName').value,
        debt_type: document.getElementById('debtType').value,
        original_amount: parseFloat(document.getElementById('debtBalance').value),
        current_balance: parseFloat(document.getElementById('debtBalance').value),
        interest_rate: parseFloat(document.getElementById('interestRate').value),
        interest_type: 'compound',
        minimum_payment: parseFloat(document.getElementById('monthlyPayment').value),
        currency: document.getElementById('debtCurrency').value,
        start_date: new Date().toISOString().split('T')[0]
      };

      await supabaseClient.from('debts').insert([debt]);
      e.target.reset();
      document.getElementById('debtPayoffPreview').classList.add('hidden');
      await loadDebts();
      renderDashboard();
    }

    function renderDebts() {
      const list = document.getElementById('debtsList');
      if (debts.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üí≥</div><p>No debts</p></div>';
        return;
      }

      list.innerHTML = debts.map(debt => {
        return '<div class="data-item"><div class="item-icon expense">üí≥</div><div class="item-details"><div class="item-title">' + debt.name + '</div><div class="item-meta">' + debt.interest_rate + '% interest</div></div><div class="item-amount negative">' + formatCurrency(debt.current_balance, debt.currency) + '</div><button class="btn btn-danger" onclick="deleteDebt(' + debt.id + ')">Delete</button></div>';
      }).join('');
    }

    async function deleteDebt(id) {
      if (!confirm('Delete?')) return;
      await supabaseClient.from('debts').delete().eq('id', id);
      await loadDebts();
      renderDashboard();
    }

    async function addRecurring(e) {
      e.preventDefault();
      const payment = {
        user_id: currentUser.id,
        name: document.getElementById('recurringName').value,
        amount: parseFloat(document.getElementById('recurringAmount').value),
        category: 'subscription',
        frequency: document.getElementById('recurringFrequency').value,
        next_due_date: document.getElementById('nextDueDate').value
      };

      await supabaseClient.from('recurring_payments').insert([payment]);
      e.target.reset();
      setDefaultDates();
      await loadRecurring();
    }

    function renderRecurring() {
      const list = document.getElementById('recurringList');
      if (recurring.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üîÑ</div><p>No recurring payments</p></div>';
        return;
      }

      list.innerHTML = recurring.map(r => {
        return '<div class="data-item"><div class="item-icon">üîÑ</div><div class="item-details"><div class="item-title">' + r.name + '</div><div class="item-meta">' + r.frequency + '</div></div><div class="item-amount negative">$' + r.amount.toFixed(2) + '</div><button class="btn btn-danger" onclick="deleteRecurring(' + r.id + ')">Delete</button></div>';
      }).join('');
    }

    async function deleteRecurring(id) {
      if (!confirm('Delete?')) return;
      await supabaseClient.from('recurring_payments').delete().eq('id', id);
      await loadRecurring();
    }

    async function addBudget(e) {
      e.preventDefault();
      const budget = {
        user_id: currentUser.id,
        category: document.getElementById('budgetCategory').value,
        limit_amount: parseFloat(document.getElementById('budgetLimit').value),
        period: 'monthly',
        currency: userCurrency
      };

      await supabaseClient.from('budget_goals').insert([budget]);
      e.target.reset();
      await loadBudgets();
    }

    function renderBudgets() {
      const list = document.getElementById('budgetsList');
      if (budgets.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üéØ</div><p>No budgets set</p></div>';
        return;
      }

      const spending = {};
      transactions.filter(t => t.type === 'expense').forEach(t => {
        spending[t.category] = (spending[t.category] || 0) + t.amount;
      });

      list.innerHTML = budgets.map(budget => {
        const spent = spending[budget.category] || 0;
        const percent = Math.min((spent / budget.limit_amount * 100), 100);
        const isOver = spent > budget.limit_amount;

        return '<div class="progress-container"><div class="progress-header"><strong>' + budget.category + '</strong><span>' + formatCurrency(spent, budget.currency) + ' / ' + formatCurrency(budget.limit_amount, budget.currency) + '</span></div><div class="progress-bar"><div class="progress-fill ' + (isOver ? 'over' : '') + '" style="width: ' + percent + '%"></div></div></div>';
      }).join('');
    }

    async function deleteBudget(id) {
      if (!confirm('Delete?')) return;
      await supabaseClient.from('budget_goals').delete().eq('id', id);
      await loadBudgets();
    }

    function renderDashboard() {
      const now = new Date();
      const thisMonth = transactions.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });

      const income = thisMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
      const expenses = thisMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
      const netWorth = accounts.reduce((sum, a) => sum + a.balance, 0) - debts.reduce((sum, d) => sum + d.current_balance, 0);
      const savingsRate = income > 0 ? ((income - expenses) / income * 100) : 0;

      document.getElementById('totalIncome').textContent = formatCurrency(income, userCurrency);
      document.getElementById('totalExpenses').textContent = formatCurrency(expenses, userCurrency);
      document.getElementById('netWorth').textContent = formatCurrency(netWorth, userCurrency);
      document.getElementById('savingsRate').textContent = savingsRate.toFixed(1) + '%';

      renderCharts();
    }

    function renderCharts() {
      const ctx1 = document.getElementById('incomeExpenseChart');
      if (charts.incomeExpense) charts.incomeExpense.destroy();
      
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push(d);
      }

      const monthlyIncome = months.map(m => {
        return transactions.filter(t => {
          const d = new Date(t.date);
          return t.type === 'income' && d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear();
        }).reduce((sum, t) => sum + t.amount, 0);
      });

      const monthlyExpenses = months.map(m => {
        return transactions.filter(t => {
          const d = new Date(t.date);
          return t.type === 'expense' && d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear();
        }).reduce((sum, t) => sum + t.amount, 0);
      });

      charts.incomeExpense = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: months.map(m => m.toLocaleDateString('en-US', { month: 'short' })),
          datasets: [{
            label: 'Income',
            data: monthlyIncome,
            backgroundColor: '#10b981'
          }, {
            label: 'Expenses',
            data: monthlyExpenses,
            backgroundColor: '#ef4444'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });

      const ctx2 = document.getElementById('categoryChart');
      if (charts.category) charts.category.destroy();
      
      const categoryData = {};
      transactions.filter(t => t.type === 'expense').forEach(t => {
        categoryData[t.category] = (categoryData[t.category] || 0) + t.amount;
      });

      if (Object.keys(categoryData).length > 0) {
        charts.category = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categoryData),
            datasets: [{
              data: Object.values(categoryData),
              backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
    }

    init();
  </script>
</body>
</html>      const savingsRate = income > 0 ? ((income - expenses) / income * 100) : 0;

      document.getElementById('totalIncome').textContent = currencies[userCurrency] + income.toFixed(2);
      document.getElementById('totalExpenses').textContent = currencies[userCurrency] + expenses.toFixed(2);
      document.getElementById('netWorth').textContent = currencies[userCurrency] + netWorth.toFixed(2);
      document.getElementById('savingsRate').textContent = savingsRate.toFixed(1) + '%';

      // Render charts
      renderCharts();
    }

    function renderCharts() {
      // Income vs Expense Chart
      const ctx1 = document.getElementById('incomeExpenseChart');
      if (charts.incomeExpense) charts.incomeExpense.destroy();
      
      const months = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push(d);
      }

      const monthlyIncome = months.map(m => {
        return transactions.filter(t => {
          const d = new Date(t.date);
          return t.type === 'income' && d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear();
        }).reduce((sum, t) => sum + t.amount, 0);
      });

      const monthlyExpenses = months.map(m => {
        return transactions.filter(t => {
          const d = new Date(t.date);
          return t.type === 'expense' && d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear();
        }).reduce((sum, t) => sum + t.amount, 0);
      });

      charts.incomeExpense = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: months.map(m => m.toLocaleDateString('en-US', { month: 'short' })),
          datasets: [{
            label: 'Income',
            data: monthlyIncome,
            backgroundColor: '#4ade80'
          }, {
            label: 'Expenses',
            data: monthlyExpenses,
            backgroundColor: '#f87171'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' }
          }
        }
      });

      // Category Chart
      const ctx2 = document.getElementById('categoryChart');
      if (charts.category) charts.category.destroy();
      
      const categoryData = {};
      transactions.filter(t => t.type === 'expense').forEach(t => {
        categoryData[t.category] = (categoryData[t.category] || 0) + t.amount;
      });

      if (Object.keys(categoryData).length > 0) {
        charts.category = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categoryData),
            datasets: [{
              data: Object.values(categoryData),
              backgroundColor: ['#333446', '#7F8CAA', '#B8CFCE', '#4ade80', '#fbbf24', '#f87171', '#60a5fa']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right' }
            }
          }
        });
      }

      // Net Worth Trend
      const ctx3 = document.getElementById('netWorthChart');
      if (charts.netWorth) charts.netWorth.destroy();
      
      const netWorthData = months.map(m => {
        const accountsBalance = accounts.reduce((sum, a) => sum + a.balance, 0);
        const debtsBalance = debts.reduce((sum, d) => sum + d.current_balance, 0);
        return accountsBalance - debtsBalance;
      });

      charts.netWorth = new Chart(ctx3, {
        type: 'line',
        data: {
          labels: months.map(m => m.toLocaleDateString('en-US', { month: 'short' })),
          datasets: [{
            label: 'Net Worth',
            data: netWorthData,
            borderColor: '#B8CFCE',
            backgroundColor: 'rgba(184, 207, 206, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          }
        }
      });

      // Growth Chart
      const growthCtx = document.getElementById('growthChart');
      if (charts.growth) charts.growth.destroy();
      
      charts.growth = new Chart(growthCtx, {
        type: 'line',
        data: {
          labels: months.map(m => m.toLocaleDateString('en-US', { month: 'short' })),
          datasets: [{
            label: 'Portfolio Value',
            data: months.map(() => Math.random() * 10000 + 50000), // Simulated data
            borderColor: '#4ade80',
            backgroundColor: 'rgba(74, 222, 128, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // Delete functions
    async function deleteAccount(id) {
      if (!confirm('Delete this account? This cannot be undone.')) return;
      await supabaseClient.from('bank_accounts').delete().eq('id', id);
      await loadAccounts();
      renderDashboard();
    }

    async function deleteTransaction(id) {
      if (!confirm('Delete this transaction?')) return;
      await supabaseClient.from('transactions').delete().eq('id', id);
      await loadTransactions();
      await loadAccounts();
      renderDashboard();
    }

    async function deleteAsset(id) {
      if (!confirm('Remove this asset from portfolio?')) return;
      await supabaseClient.from('portfolio_assets').delete().eq('id', id);
      await loadPortfolio();
    }

    async function deleteDebt(id) {
      if (!confirm('Remove this debt?')) return;
      await supabaseClient.from('debts').delete().eq('id', id);
      await loadDebts();
      renderDashboard();
    }

    async function deletePiggyBank(id) {
      if (!confirm('Delete this savings goal?')) return;
      await supabaseClient.from('piggy_banks').delete().eq('id', id);
      await loadPiggyBanks();
    }

    async function deleteRecurring(id) {
      if (!confirm('Remove this recurring payment?')) return;
      await supabaseClient.from('recurring_payments').delete().eq('id', id);
      await loadRecurring();
    }

    async function deleteBudget(id) {
      if (!confirm('Remove this budget?')) return;
      await supabaseClient.from('budget_goals').delete().eq('id', id);
      await loadBudgets();
    }

    function showQuickAdd() {
      alert('Quick add modal would open here - add income/expense quickly');
    }

    async function logout() {
      if (confirm('Are you sure you want to logout?')) {
        await supabaseClient.auth.signOut();
        window.location.href = 'clearbalance-landing.html';
      }
    }

    // Initialize app
    init();

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (localStorage.getItem('themePreference') === 'auto') {
        applyTheme('auto');
      }
    });
  </script>
</body>
</html>
